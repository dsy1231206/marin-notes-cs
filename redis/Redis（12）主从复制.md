# Redis（12）主从复制

## 1、简介

主机数据更新后根据配置和策略，自动同步到备机的master/slave机制，Master以写为主，Slave以读为主

这样就可以实现读写分离，容灾快速恢复，所以一般都是一主多从的效果。



## 2、怎么配置

##### 常用方法

复制出redis.conf配置文件到一个新文件夹，再创建多个redisxxx.conf文件

在新建的配置文件中写入：

```
include /DIR**/redis.conf #导入配置文件
pidfile /var/run/redis_xxxx.pid # pid文件，该文件记录了进程的ID
port xxxx # 端口号
dbfilename dumpxxxx.rdb # rdb文件名称

改：
appendonly no
```

启动三台redis服务器

```
redis-server redis.conf # 在配置文件目录下
```



查看当前主机运行状况：

```
info replication
```



配置从机：

```
slaveof <ip> <port>
```



## 3、复制原理和一主二从

##### 一主二从

###### 1）从服务器挂掉，重启之后重新执行slaveof <ip> <port>，恢复之后依然能持有主服务器的数据

###### 2）主服务器挂掉，从服务器一直是从服务器，主服务器重启之后依然是主服务器



##### 主从复制原理

1）从服务器连接上主服务器之后，向主服务器发送进行数据同步的消息sync。

2）主服务器接到从服务器发送过来的同步消息之后，会把主服务器的数据进行持久化（RDB），把rdb文件发送给从服务器，从服务器拿到rdb文件进行读取

3）每次主服务器进行写操作，和从服务器进行数据同步



##### 薪火相传

主服务器只同步数据到一台从服务器上，通过这个从服务器向其他从服务器同步数据



##### 反客为主

```
slaveof no one #将从机变成主机
```

缺点是需要手动完成。

哨兵模式是反客为主的自动版



## 4、哨兵模式（sentinel）

##### 使用

新建一个配置文件，sentinel.conf（名字不能错）

填写内容：

```
sentinel monitor mymaster 127.0.0.1 6379 1
```

mymaster是给监控对象起的名称

1是至少有多少个哨兵同意迁移的数量

启动哨兵：

```
redis-sentinel /myredis/sentinel.conf
```



###### 主机挂了重启，就会变成从机slave



##### 复制延时

所有的写操作都是先在主机操作再同步到从机，所以同步有一定延迟。



##### 选择从机规则依次：

###### 1）优先级靠前

​		优先级在redis.conf中配置：replica-priority 100，值越小优先级越高

###### 2）选择偏移量最大的

​		偏移量是获取原主机数据最全的

###### 3）选择runid最小的从服务器

​		每个redis启动后会生成一个随机的40位runid



​		



